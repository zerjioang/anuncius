worker_processes 4;

events { worker_connections 1024; }

http {

	#configure ssl for all servers
	include /etc/nginx/mime.types;

	#server load balancer

        upstream anuncius_app {
              least_conn;
              server web:8080 weight=10 max_fails=3 fail_timeout=3s;
	    # server web2:8080 weight=10 max_fails=3 fail_timeout=3s;
        }

	# redirect from http://www.anunci.us to https://anunci.us
	server {
		# Redirect any http requests to https
		listen 80;
		server_name www.anunci.us;
		return 301 https://anunci.us$request_uri;
	}

	# redirect from http://anunci.us to https://anunci.us
        server {
                # Redirect any http requests to https
		listen 80;
                server_name anunci.us;
                return 301 https://anunci.us$request_uri;
        }

	# redirect from https://www.anunci.us to https://anunci.us
        server {
                # Redirect any http requests to https
                listen 443;
                server_name www.anunci.us;
                return 301 https://anunci.us$request_uri;
        }

	#server: https://anunci.us
        server {
		listen 443 default http2 ssl;
		server_name anunci.us;

		#configurar ssl
		include /config/ssl.conf;

		#nginx hardening general
		include /config/hardening.conf;


		location /robots.txt {
                        return 301 https://static.anunci.us$request_uri;
                }

		location /sitemap.xml {
                        return 301 https://static.anunci.us$request_uri;
                }

		location / {

			#compression

			gzip on;
			gzip_http_version 1.1;
			gzip_vary on;
			gzip_comp_level 6;
			gzip_proxied any;
			gzip_types text/html application/rss+xml;
			gzip_buffers 16 8k;
			gzip_disable "MSIE [1-6]\.(?!.*SV1)";

			#cache

			expires 30d;
                        add_header Pragma public;
                        add_header Cache-Control "public";

			#proxy

			proxy_pass http://anuncius_app;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection 'upgrade';
			proxy_set_header Host $host;
			proxy_cache_bypass $http_upgrade;
		}
        }

	# static.anunci.us
        server {
                listen 443 http2 ssl;
                server_name static.anunci.us www.static.anunci.us;

		location / {

			#compression

                        gzip on;
                        gzip_http_version 1.1;
                        gzip_vary on;
                        gzip_comp_level 6;
                        gzip_proxied any;
                        gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml  text/javascript application/javascript text/x-js image/png image/jpg image/jpeg image/bmp image/gif;
                        gzip_buffers 16 8k;
                        gzip_disable "MSIE [1-6]\.(?!.*SV1)";

			#cache

			expires 30d;
			add_header Pragma public;
			add_header Cache-Control "public";

			#enable cors

			add_header 'Access-Control-Allow-Origin' '*';
                        add_header 'Access-Control-Allow-Methods' 'GET, POST';
                        add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

			#optimize file send
	
                        sendfile on;
			sendfile_max_chunk 1m;
			root /usr/share/nginx/html/static;
                }
        }

	# jenkins.anunci.us
	server {
		listen 443 http2 ssl;
		server_name jenkins.anunci.us www.jenkins.anunci.us;
		location / {
			proxy_pass http://anuncius_app/jenkins$request_uri;
			proxy_set_header Host anunci.us;
		}
	}

	# api.anunci.us
	server {
		listen 443 http2 ssl;
		server_name api.anunci.us www.api.anunci.us;
	
		#nginx hardening general
                include /config/hardening.conf;	

		location / {

                        add_header 'Access-Control-Allow-Origin' '*';
                        add_header 'Access-Control-Allow-Methods' 'GET, POST';
                        add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';

			proxy_pass http://anuncius_app/api$request_uri;
			proxy_set_header Host anunci.us;
		}
	}
	
	# manager.anunci.us
        server {
                listen 443 http2 ssl;
                server_name manager.anunci.us www.manager.anunci.us;
                location / {
                        proxy_pass http://anuncius_app/manager$request_uri;
                        proxy_set_header Host anunci.us;
                }
        }

	#if someone attempts to access using server IP address, ban it
        server {
                server_name 52.212.54.13;
                return 401;
        }
}
